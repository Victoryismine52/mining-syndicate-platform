# Storage Backend Implementation Plan

## Overview
Implement a flexible storage backend system that allows per-request storage selection while maintaining backward compatibility with current behavior.

## Goals
1. Enable per-request storage backend selection
2. Maintain backward compatibility (default to environment config)
3. Ensure zero-downtime migration path
4. Add debugging/monitoring capabilities

## Implementation Steps

### Phase 1: Core Infrastructure

1. Create Storage Options Interface
```typescript
// shared/types/storage.ts
export interface StorageOptions {
  useMemoryStorage?: boolean;      // Use in-memory storage
  storageType?: 'memory' | 'cloud'; // Explicit storage type
  debugMode?: boolean;             // Enable detailed logging
  cacheTTL?: number;               // Cache duration in seconds
}
```

2. Create Storage Context Class
```typescript
// server/storage/StorageContext.ts
class StorageContext {
  constructor(private defaultOptions: StorageOptions = {}) {}
  
  getOptions(requestOptions?: StorageOptions): StorageOptions {
    // Default to environment config if not specified
    const useMemory = requestOptions?.useMemoryStorage ?? 
                     (config.storageMode === 'memory');
    return {
      ...this.defaultOptions,
      ...requestOptions,
      useMemoryStorage: useMemory
    };
  }
}
```

### Phase 2: Service Layer Updates

1. Update ObjectStorageService (In Progress)
- [x] Add options to getSlideFile
- [x] Add options to downloadObject
- [x] Add options to other methods (searchPublicObject, getSlideUploadURL)
- [x] Add storage type to response headers (applied in routes for uploads/images)

2. Update SiteStorage Service
- [ ] Update interface to accept options
- [ ] Implement MemorySiteStorage
- [ ] Implement CloudSiteStorage
- [ ] Add factory method for storage selection

3. Create Common Storage Base Class
```typescript
abstract class BaseStorage {
  protected getClient(options?: StorageOptions) {
    return options?.useMemoryStorage ? 
           new MemoryStorage() : 
           getCloudStorageClient();
  }
}
```

### Phase 3: API Layer Integration

1. Create Storage Middleware
```typescript
const storageMiddleware = (defaultOptions?: StorageOptions) => 
  (req: Request, _res: Response, next: NextFunction) => {
    req.storageOptions = {
      useMemoryStorage: config.storageMode === 'memory',
      ...defaultOptions,
      ...req.query.storage // Allow override via query params in dev
    };
    next();
  };
```

2. Update Route Handlers
- [~] Add storage options parameter to all storage service calls (slides + images updated)
- [~] Pass request storage options through (middleware + selected routes)
- [x] Add storage type headers to responses (slides upload/image routes)

3. Add Debug Headers
```typescript
X-Storage-Type: memory|cloud
X-Storage-Cache: hit|miss
X-Storage-Latency: 123ms
```

### Phase 4: Testing Infrastructure

1. Create Storage Test Helpers
```typescript
const withStorage = (type: 'memory' | 'cloud') => 
  (testFn: Function) => async () => {
    const options = { useMemoryStorage: type === 'memory' };
    await testFn(options);
  };
```

2. Update Existing Tests
- [ ] Add storage options to all test cases
- [ ] Test both memory and cloud paths
- [ ] Add storage-specific assertions

### Phase 5: Monitoring & Observability

1. Add Storage Metrics
- [ ] Operation latency by storage type
- [ ] Cache hit/miss ratios
- [ ] Error rates by storage type

2. Add Debug Logging
- [ ] Storage selection decisions
- [ ] Performance metrics
- [ ] Error details

## Migration Path

### Step 1: Infrastructure Updates
1. Deploy new storage interfaces
2. Add storage options parameters (optional)
3. Default to current behavior

### Step 2: Gradual Migration
1. Update services to accept options
2. Keep defaulting to environment config
3. Test both paths in staging

### Step 3: Feature Flag
1. Add feature flag for new storage layer
2. Enable for test accounts
3. Monitor performance/errors

### Step 4: Full Rollout
1. Enable for all requests
2. Monitor metrics
3. Handle any issues

## Backward Compatibility
- All methods default to current behavior if no options provided
- Environment variables still control default behavior
- New parameters are optional
- Storage headers are additive

## Testing Requirements

1. Unit Tests
- Test both storage backends
- Verify default behaviors
- Test error handling

2. Integration Tests
- Full request flow with both backends
- Middleware integration
- Header presence and accuracy

3. Performance Tests
- Latency comparison
- Cache effectiveness
- Error rates

## Success Metrics

1. Technical Metrics
- Zero regression bugs
- Response time <= current
- Error rate <= current

2. Operational Metrics
- Successful failover tests
- Cache hit ratio targets
- Error recovery time

## Future Enhancements

1. Additional Storage Backends
- S3 compatibility layer
- Local filesystem option
- Custom implementation support

2. Advanced Features
- Cross-storage replication
- Automatic failover
- Cache warming

3. Management Features
- Storage dashboard
- Real-time metrics
- Configuration UI

## Timeline
- Phase 1: 1 day
- Phase 2: 2 days
- Phase 3: 2 days
- Phase 4: 1 day
- Phase 5: 1 day
- Testing & Fixes: 2 days

Total: ~9 days for full implementation

## Memory Storage Seed Data Structure

### Overview
The memory storage system uses comprehensive seed data to provide a realistic testing environment. The seed data is generated by `scripts/seed-memory.ts` and stored in `server/data/seed.json`.

### Seed Data Entities

#### Sites
- **demo site**: Standard mining syndicate presentation site
- Contains basic site metadata and configuration

#### Site Leads (3 samples)
- **learn-more lead**: General information request
- **mining-pool lead**: Investment opportunity with amount specification
- **lending-pool lead**: Lending opportunity with interest rate details
- Each lead includes form data, submission tracking, and aggregation by email identifier

#### Site Analytics (3 samples)
- **page_view**: User navigation tracking
- **form_submission**: Lead generation tracking  
- **slide_view**: Presentation engagement metrics
- Includes event metadata, timestamps, and user interaction data

#### Site Managers (2 samples)
- **admin@local.dev**: Primary administrator
- **manager@local.dev**: Secondary manager
- Provides access control for site management features

#### Legal Disclaimers (3 samples)
- **Investment Risk Disclaimer**: Financial risk warnings
- **Privacy Policy**: Data protection compliance
- **Terms of Service**: Usage agreement
- Applied to site types and linked via siteDisclaimers

#### Site Slides (17 slides from slides.json)
- Complete mining syndicate presentation content
- Includes titles, image URLs, slide ordering, and descriptions
- Covers: welcome, infrastructure, investments, technology, market analysis, financial projections, risk management, partnerships, operations, sustainability, community impact, innovation, expansion, compliance, team, metrics, vision

#### Global Slides (2 samples)
- **global-intro**: Universal introduction slide
- **global-closing**: Universal closing slide  
- Shared across all sites with global slide keys

#### Site Sections (3 samples)
- **Investment Overview**: Investment opportunity details
- **Technology & Operations**: Technical and operational content
- **Financial Projections**: Financial analysis content
- Provides content organization and navigation structure

#### Site Memberships (2 samples)
- **member1@example.com**: Active member
- **member2@example.com**: Active member
- Tracks user access and membership status

### Data Relationships
- Sites → Site Leads (via siteId)
- Sites → Site Analytics (via siteId)
- Sites → Site Managers (via siteId)
- Sites → Site Slides (via siteId)
- Sites → Site Sections (via siteId)
- Sites → Site Memberships (via siteId)
- Legal Disclaimers → Site Disclaimers → Sites (many-to-many)
- Global Slides (shared across all sites)

### Usage in Memory Mode
- Enables rapid prototyping without database setup
- Provides realistic data for testing all platform features
- Supports lead management, analytics, content management, and access control
- Includes comprehensive mining syndicate presentation content
- Facilitates testing of multi-site scenarios
